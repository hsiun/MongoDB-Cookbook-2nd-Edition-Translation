# 在shell中创建背景索引和前景索引

在我们之前的菜谱中，我们学习了如何分析查询，如何决定创建何种索引，和如何创建索引。这本身是简单的，看起来相当简单。然而，对于大的集合，由于创建索引时间很长，事情在一开始就是变得很糟。这个菜谱的目的在于对这些概念做一些阐明，创建索引时避免这些陷阱，特别是在大集合。


### 前提条件
为了创建索引，我们需要有一个启动并运行的服务。我们只需要一个简单的单节点服务器。为了创建索引，我们需要启动并运行服务器。一个简单的单节点服务器就是我们需要的。有关如何启动服务器的说明，请参阅第一章_安装和启动服务器_中的_安装单节点MongoDB_菜谱（G）。

通过在操作系统的shell中输入`mongo`启动两个mongo服务器的shell。默认情况下，这两个都会连接到`test`数据库。

我们压缩的测试数据太小了不能用来演示在大集合上创建索引所面临的问题。我们需要更多的数据，因此我们将创建一些数据来模拟创建索引时候面临的问题。这些数据是没有实际意义的，但是足够用来测试概念了。复制下面所有的代码片段到启动了的shell中并执行：（这是一个很容易输入的片段。）
```
for(i = 0; i < 5000000 ; i++) {
 doc = {}
 doc._id = i
 doc.value = 'Some text with no meaning and number ' + i + ' in
 between'
 db.indexTest.insert(doc)
}
```
这个集合中的文档看起来如下所示：
```
{ _id:0, value:"Some text with no meaning and number 0 in between" }
```

这个执行将花费蛮多时间，因此我们需要耐心点。一旦执行结束，准备活动就完成了。


> 如果你急于知道集合中当前文档数，定期从第二个shell中执行下面命令：
> ```
> db.indexTest.count()
> ```


### 如何操作...
1. 在文档的`value`域创建索引，如下所示：
```
> db.indexTest.createIndex({value:1})
```

2. 在创建索引的过程中，这会花点时间，转换到第二个控制台，并执行下面语句：
```
> db.indexTest.findOne()
```

3. 索引创建的shell和执行`findOne`的shell都将会阻塞，在索引创建完成之前他们都不会有提示输出。

4. 现在在默认情况下，创建的是前景索引。我们将会看看创建后置索引时的情形。如下所示，删除索引：
```
> db.indexTest.dropIndex({value:1})
```

5. 再次创建索引，大事这次是背景索引，如下：
```
> db.indexTest.createIndex({value:1}, {background:true})
```

6. 在第二个shell中执行`findOne`，如下：
```
> db.indexTest.findOne()
```

7. 这将会返回一个文档，不像第一个示例，在前景索引中这个操作在索引创建完成之前都会被阻塞。

8. 在第二个shell中，在索引创建完成的过程中以四到五秒的间隔反复执行下面的操作。
```
> db.indexTest.find({value:"Some text with no meaning and number 0
in between"}).explain()
```

### 如何实现...
现在让我们分析下我们做了什么。我们创建了大概五百万个没有实际用处的文档，但是我们